From 10668abd8d4fdb5749d845c56ae032a54004c2f5 Mon Sep 17 00:00:00 2001
From: Adrien Plazas <kekun.plazas@laposte.net>
Date: Fri, 10 Mar 2017 07:24:33 +0100
Subject: [PATCH] libretro: Remove reset in retro_run() hack

Removes a hack breaking deserialization when running retro_reset(),
retro_unserialize() and retro_run() in this order, as it silently resets
the core just after setting its state.
---
 frontend/libretro.c | 32 +-------------------------------
 1 file changed, 1 insertion(+), 31 deletions(-)

diff --git a/frontend/libretro.c b/frontend/libretro.c
index e5ce194..e72edc5 100644
--- a/frontend/libretro.c
+++ b/frontend/libretro.c
@@ -50,9 +50,6 @@
 
 #define ISHEXDEC ((buf[cursor]>='0') && (buf[cursor]<='9')) || ((buf[cursor]>='a') && (buf[cursor]<='f')) || ((buf[cursor]>='A') && (buf[cursor]<='F'))
 
-//hack to prevent retroarch freezing when reseting in the menu but not while running with the hot key
-static int rebootemu = 0;
-
 static retro_video_refresh_t video_cb;
 static retro_input_poll_t input_poll_cb;
 static retro_input_state_t input_state_cb;
@@ -1340,9 +1337,7 @@ size_t retro_get_memory_size(unsigned id)
 
 void retro_reset(void)
 {
-   //hack to prevent retroarch freezing when reseting in the menu but not while running with the hot key
-   rebootemu = 1;
-	//SysReset();
+	SysReset();
 }
 
 static const unsigned short retro_psx_map[] = {
@@ -1591,22 +1586,6 @@ static void update_variables(bool in_flight)
    else
    {
       //not yet running
-
-      //bootlogo display hack
-      if (found_bios) {
-         var.value = "NULL";
-         var.key = "pcsx_rearmed_show_bios_bootlogo";
-         if (environ_cb(RETRO_ENVIRONMENT_GET_VARIABLE, &var) || var.value)
-         {
-            Config.SlowBoot = 0;
-            rebootemu = 0;
-            if (strcmp(var.value, "enabled") == 0)
-            {
-               Config.SlowBoot = 1;
-               rebootemu = 1;
-            }
-         }
-      }
 #ifndef DRC_DISABLE
       var.value = "NULL";
       var.key = "pcsx_rearmed_psxclock";
@@ -1654,15 +1633,6 @@ static uint16_t get_analog_button(retro_input_state_t input_state_cb, int player
 void retro_run(void)
 {
 	int i;
-	//SysReset must be run while core is running,Not in menu (Locks up Retroarch)
-	if (rebootemu != 0) {
-		rebootemu = 0;
-		SysReset();
-		if (!Config.HLE && !Config.SlowBoot) {
-			// skip BIOS logos
-			psxRegs.pc = psxRegs.GPR.n.ra;
-		}
-	}
 
 	input_poll_cb();
 
-- 
2.21.0

